<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="codereview-summarize.js"></script>
<script src="latency-info.js"></script>

<dom-module id="cz-review-latency">

  <template>
  </template>

  <script>
    Polymer({
      is: "cz-review-latency",

      registerQuery: function(query, callback) {
        registerSource("cz-codereview", {user: query.email, type: 'search', isOwner: query.isOwner}, function(data) {

          if (data == null) {
            // invalid user
            callback({error: "user not found"});
            return;
          }

          var issues = data.results.map(fastAnnotate);
          var maxLatency = query.maxLatency

          var results = {};

          issues.forEach(issue => {
            for (var email in issue.pendingWaiting) {
              if (results[email] == undefined) {
                results[email] = new LatencyInfo();
              }

              var soleLatency = issue.pendingWaiting[email].sole / 1000 / 60 / 60;
              var sharedLatency = issue.pendingWaiting[email].shared / 1000 / 60 / 60;

              if (soleLatency + sharedLatency > 24 * 31) {
                results[email].abandonedBugs.push(issue.issue);
              } else {
                if (maxLatency) {
                  if (soleLatency > results[email].latency) {
                    results[email].latency = soleLatency
                  }
                  if (sharedLatency > results[email].multipleLatency){
                    results[email].multipleLatency = sharedLatency;
                  }
                } else { // Get the total latency instead
                  results[email].latency += soleLatency;
                  results[email].multipleLatency += sharedLatency;
                }

                if (soleLatency > 0) {
                  results[email].latencyPerBug.push({subject: issue.subject, owner: issue.owner,
                                    issue: issue.issue, latency: soleLatency});
                }
                if (sharedLatency > 0)
                  results[email].multipleOutstanding.push({subject: issue.subject, owner: issue.owner,
                                          issue: issue.issue, latency: sharedLatency})
              }
            }
          });
          callback(results);
        }.bind(this));
      }
    });
  </script>

</dom-module>
