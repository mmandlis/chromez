<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="codereview-summarize.js"></script>

<dom-module id="cz-review-latency">

  <template>
  </template>

  <script>
    Polymer({
      is: "cz-review-latency",

      registerQuery: function(query, callback) {
        registerSource("cz-codereview", {user: query.email, type: 'search'}, function(data) {

          if (data == null) {
            // invalid user
            callback({error: "user not found"});
            return;
          }

          var issues = data.results.map(fastAnnotate);
          var maxLatency = query.maxLatency

          var latency = 0;
          var abandonedBugs = [];
          var latencyPerBug = [];
          var multipleOutstanding = [];
          var multipleLatency = 0;

          issues.forEach(issue => {
            if (issue.pendingWaiting[query.email]) {
              var soleLatency = issue.pendingWaiting[query.email].sole / 1000 / 60 / 60;
              var sharedLatency = issue.pendingWaiting[query.email].shared / 1000 / 60 / 60;

              if (soleLatency + sharedLatency > 24 * 31) {
                abandonedBugs.push(issue.issue);
              } else {
                if (maxLatency) {
                  if (soleLatency > latency) {
                    latency = soleLatency
                  }
                  if (sharedLatency > multipleLatency){
                    multipleLatency = sharedLatency;
                  }
                } else { // Get the total latency instead
                  latency += soleLatency;
                  multipleLatency += sharedLatency;
                }

                if (soleLatency > 0) {
                  latencyPerBug.push({subject: issue.subject, owner: issue.owner,
                                    issue: issue.issue, latency: soleLatency});
                }
                if (sharedLatency > 0)
                  multipleOutstanding.push({subject: issue.subject, owner: issue.owner,
                                          issue: issue.issue, latency: sharedLatency})
              }
            }
          });
          callback({latency: latency, abandonedBugs: abandonedBugs,
                    latencyPerBug: latencyPerBug, multipleLatency: multipleLatency,
                    multipleOutstanding: multipleOutstanding});
        }.bind(this));
      }
    });
  </script>

</dom-module>
